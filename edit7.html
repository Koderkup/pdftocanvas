<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>PDF Unicode Editor â€” DejaVu Sans</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; background: #f9f9f9; text-align: center; padding: 1rem; }
    canvas { border: 1px solid #ccc; margin: 1rem auto; display: block; }
    .controls, .editor {
      margin: 1rem auto;
      display: flex; flex-wrap: wrap;
      justify-content: center; gap: 0.5rem; max-width: 800px;
    }
    input, button, textarea { font-size: 1rem; padding: 0.5rem; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .status { margin-top: 1rem; font-size: 1rem; color: #333; }
  </style>
</head>
<body>

<h2>ğŸ“„ PDF Unicode Editor</h2>
<input type="file" id="pdf-file" accept="application/pdf" />
<button id="load-btn">ğŸ“‚ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ PDF</button>

<canvas id="pdf-canvas"></canvas>

<div class="controls">
  <button id="prev-page">â¬…</button>
  <button id="next-page">â¡</button>
  <input type="number" id="jump-input" min="1" placeholder="Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°" />
  <button id="jump-btn">ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸</button>
  <button id="zoom-in">ğŸ”+</button>
  <button id="zoom-out">ğŸ”-</button>
</div>

<div class="status">Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°: <span id="page-num">â€“</span> / <span id="page-count">â€“</span></div>

<h3>âœï¸ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚</h3>
<div class="editor">
  <textarea id="text-input" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ â€” ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ ğŸ˜Š Ø£Ù‡Ù„Ø§Ù‹ ã“ã‚“ã«ã¡ã¯" rows="3" cols="30"></textarea>
  <input type="number" id="text-page" placeholder="Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°" min="1" />
  <input type="number" id="text-x" placeholder="X Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ" min="0" />
  <input type="number" id="text-y" placeholder="Y Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ" min="0" />
</div>
<button id="save-btn" disabled>ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ PDF</button>

<!-- JS-Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.js"></script>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.worker.min.js";

  const canvas = document.getElementById("pdf-canvas");
  const ctx = canvas.getContext("2d");
  let pdfDoc = null;
  let originalFile = null;
  let pageNum = 1;
  let pageCount = 0;
  let scale = 1.2;

  async function renderPage(n) {
    const page = await pdfDoc.getPage(n);
    const viewport = page.getViewport({ scale });
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    await page.render({ canvasContext: ctx, viewport }).promise;
    document.getElementById("page-num").textContent = n;
  }

  document.getElementById("load-btn").onclick = () => {
    originalFile = document.getElementById("pdf-file").files[0];
    if (!originalFile) return alert("âš ï¸ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ PDF-Ñ„Ğ°Ğ¹Ğ».");
    const reader = new FileReader();
    reader.onload = async () => {
      const bytes = new Uint8Array(reader.result);
      pdfDoc = await pdfjsLib.getDocument({ data: bytes }).promise;
      pageCount = pdfDoc.numPages;
      pageNum = 1;
      document.getElementById("page-count").textContent = pageCount;
      await renderPage(pageNum);
      document.getElementById("save-btn").disabled = false;
    };
    reader.readAsArrayBuffer(originalFile);
  };

  document.getElementById("prev-page").onclick = () => {
    if (pageNum > 1) renderPage(--pageNum);
  };
  document.getElementById("next-page").onclick = () => {
    if (pageNum < pageCount) renderPage(++pageNum);
  };
  document.getElementById("jump-btn").onclick = () => {
    const val = parseInt(document.getElementById("jump-input").value);
    if (val >= 1 && val <= pageCount) { pageNum = val; renderPage(val); }
  };
  document.getElementById("zoom-in").onclick = () => {
    scale = Math.min(scale + 0.2, 3); renderPage(pageNum);
  };
  document.getElementById("zoom-out").onclick = () => {
    scale = Math.max(scale - 0.2, 0.4); renderPage(pageNum);
  };

  document.getElementById("save-btn").onclick = () => {
    if (!originalFile) return alert("ğŸ“› PDF Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½.");
    const text = document.getElementById("text-input").value.trim();
    const page = parseInt(document.getElementById("text-page").value);
    const x = parseInt(document.getElementById("text-x").value);
    const y = parseInt(document.getElementById("text-y").value);
    if (!text || isNaN(page) || isNaN(x) || isNaN(y)) {
      return alert("âš ï¸ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ.");
    }

    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const pdfBytes = new Uint8Array(reader.result);
        const doc = await PDFLib.PDFDocument.load(pdfBytes);
        doc.registerFontkit(fontkit);

        // Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Unicode-ÑˆÑ€Ğ¸Ñ„Ñ‚: DejaVu Sans
        const fontBytes = await fetch("https://cdn.jsdelivr.net/npm/dejavu-fonts-ttf@2.37/ttf/DejaVuSans.ttf")
          .then(res => res.arrayBuffer());
        const customFont = await doc.embedFont(fontBytes);

        const pages = doc.getPages();
        if (page < 1 || page > pages.length) {
          return alert(`âŒ Ğ’ PDF Ğ²ÑĞµĞ³Ğ¾ ${pages.length} ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†.`);
        }

        pages[page - 1].drawText(text, {
          x, y, font: customFont, size: 16, color: PDFLib.rgb(0, 0, 0)
        });

        const output = await doc.save();
        const blob = new Blob([output], { type: 'application/pdf' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "unicode_text.pdf";
        link.click();
        setTimeout(() => URL.revokeObjectURL(link.href), 1500);
      } catch (e) {
        alert("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğ¸: " + e.message);
      }
    };
    reader.readAsArrayBuffer(originalFile);
  };
</script>

</body>
</html>
